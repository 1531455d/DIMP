# DIMP（去中心化即时通讯协议）技术白皮书 (V0.1)

草案：**2018年11月11日** (@moky)

**摘要:** 本文档引入一种新的为即时通讯而设计的协议，以及一个为开发分布式即时通讯应用而设计的技术架构。该软件提供了一个账号系统（用户身份认证）以及在各账号之间通过端对端加密实现的安全通讯服务。

Copyright &copy; 2018 Albert Moky

## 0. 背景
即时通讯（IM）是目前 Internet 上最为流行的通讯方式，它允许网络上的两个人或多人使用网络实时的传递文字消息、文件、语音与视频交流。
从用户使用场景角度，目前市场上的IM工具可划分为**企业级IM工具**（如钉钉、企业微信、RTX 等）和**个人IM工具**（如 WeChat、QQ、Facebook、Whatsapp、Telegram 等）两大类。

而当前所有最流行的 IM 工具其平台架构设计都是中心化的，每个工具背后都是一套自有的账号认证系统以及消息转发系统。这将造成至少以下3个难以解决或避免的关键性问题：

1. 每个用户的账号密码以及关系链等重要资料都被绑定在特定的平台上，其他平台无法共享；
2. 每个平台需要中心化的数据库来存储用户账号密码等资料，这些中心点很容易成为黑客攻击的目标；
3. 用户完全依赖于其所在的 IM 平台处理能力，一旦出现中心故障将可能导致无法登录与通讯。

问题1的主要症结在于这种中心化机制不利于**持续创新**，容易形成**寡头垄断**市场。而一旦垄断形成，即使寡头丧失创新能力，其用户也会由于迁移成本过高而必须继续忍受其落后的通讯方式，难以享受其他开发者提供的更优质的服务。

同时由于各家平台账号难以互通，即使寡头尚未完全形成，几家头部企业的用户相互之间也无法通讯。从而导致每个用户需要同时安装多个客户端并频繁切换的不良体验。

更进一步地，由于用户需求的多样性，很难在一款 IM 工具上承载所有的用户需求特性，而同时开发和维护多款 IM 工具显然超出了一家企业的能力范围（无论这家企业多么庞大）。

问题2的主要症结在于**信息安全**。由于中心化的账号系统设计，给黑客创造了大批量窃取用户资料的有利条件。

问题3的重点是**单点故障**风险，平台需要投入巨大资源以确保其网络（尤其是中心节点）正常运行。而一旦由于某些原因导致该平台停止服务，用户除了等待平台自行修复，在有限的时间内几乎可以说是毫无选择的主动权。

在中心化 IM 技术已发展完备的今天，以上问题（或隐患）一直未能彻底消除，所以市场需要一种全新的去中心化的 IM 技术来满足更安全更丰富的通讯需求。

## 1. 去中心化 IM 工具的需求
IM 工具的竞争，是当今互联网世界最激烈的竞争领域之一，且已基本形成寡头垄断态势。为了在这个已被深耕多年的领域生存和发展，基于去中心化设计的 IM 工具必须要满足以下的要求，才能解决中心化 IM 所不能解决的那些问题，进而赢得广泛的应用。

### 去中心化的用户身份认证技术
去中心化 IM，首先要解决的就是去中心化用户身份认证技术。现有的用户身份认证系统，依靠的是简单的 ID+Password 配对技术，也即需要一个可靠的数据库去保存配对信息，因此中心化不可避免。

去中心化的用户身份认证系统，需要从算法上保证无需中心化数据库来保存配对信息，仅仅基于**共识算法**就可以实现身份认证。

### 基于端对端加密的安全通讯技术
中心化 IM 由于其服务提供者（SP）的唯一性，所有的信息安全问题都必须且只能由 SP 负责解决，用户只能选择信任 SP。而去中心化的 IM 系统中，任何人都可以成为 SP 为他人提供服务，因此我们不能完全信任任何一个 SP，从而必须在算法上保证在所有网络节点都不足信的前提之下，依然能够放心的进行通讯。

因此，基于端对端加密的通讯技术成为了必选。

### 高并发（支持亿级用户）
目前所有头部的 IM 服务提供商都拥有**亿级**以上的庞大用户群体，如国内的微信、QQ 月活跃用户已近10亿，而国外的 Facebook 更是高达20亿。因此一个可以处理极其庞大用户的高并发系统设计对于去中心化 IM 技术是至关重要的。

### 低延时
一个好的 IM 软件，需要有秒级的送达能力，才能保证**实时通讯**的良好体验。高延时的系统设计甚至不能称之为 IM 技术。

### 免费使用
一个可以免费供普通用户使用的 IM 软件或许将会在现有的 IM 领域中得到更为广泛的应用。

### 可定制、可升级
一个可根据不同人群通过定制、升级来扩展高级功能的 IM 平台，将会得到更多的开发者支持，从而衍生出更丰富的产品特性，满足更多的用户需求。

## 2. 共识
DIMP 引入了3类信息的共识机制：身份确认算法、关系维护机制、消息格式（含加密与校验算法），以保证整个系统稳定可靠地运行。

### 身份确认
首先，用户账号 ID 通过一个我称之为“元”（Meta）的数据结构来生成，该生成算法确保了用户的 ID 与其非对称密钥对（PK+SK）之间的关联关系。

当一个节点或客户端从其他节点获得一个宣称与某 ID 对应的 Meta 信息时，可以根据共识算法自行校验。如果校验通过，则确认 Meta 信息中包含的公钥（PK）信息合法，并加入本地的数据库中。由于 Meta 算法的确定性，任何一个节点或客户端都可以判断 ID & PK 的对应关系是否合法，无需第三方机构证明。

ID 的地址生成算法我参考了 BitCoin 的地址生成算法，并做了一点微小的升级，使其能包含一个人类可读的 **name** 信息，同时还增加了一个更有利于搜索账号（而不是只能复制粘贴地址）的 **number** 属性。相信以上两个扩展将会令其作为 IM 账号更加友好并更容易推广。

### 关系维护
对于“群租”（Group）等包含关系网络的信息，我们可以采用类似于区块链的共识机制，通过签名+投票的形式实现关系维护和演变。

### 消息加密与校验
DIMP 制定了统一的消息格式与加密/校验机制。每一条信息在发到网络中之前都必须事先进行加密和签名，从而确保任何中间节点不能窃听或篡改其中的内容。具体地，信息的发送需要额外的两个步骤：

1. 用接收方的公钥对消息体进行加密（为提高效率，可以先使用对称密码 PW 对消息体进行加密，然后用接收方公钥对 PW 进行加密）得到密文；
2. 用发送方的私钥对密文进行签名（先求取密文的摘要，再对摘要进行签名）。

类似地，信息的接收也需要两个对应的步骤：

1. 用发送方的公钥对密文和签名进行校验（先求得密文的摘要，再对摘要进行校验）；
2. 用接收方的私钥对密文进行解密（先解密得到对称密码 PW，再用 PW 对密文进行解密还原消息体）。

通过以上算法，既能确保信息不被任何中间节点窃取，也能防止第三方篡改，从而实现安全可靠的去中心化通讯。

## 3. 账号
## 4. 消息
## 5. 扩展
## 6. 结论

