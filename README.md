# Decentralized Instant Messaging Protocol (DIMP)

## 0. Abstract
This document introduces a new protocol designed for instant messaging and an architecture for developing decentralized IM applications. The software provides accounts(user identity recognition) and communications(instant message) between accounts safely by end-to-end encryption.

It includes just TWO extremely simple parts:

1. Account
2. Message

## 1. Account

### 1.0. Meta
The **Meta** was generated by your private key,
it can be used to build a new ID for entity, or verify the ID/PK pair.

The 'Meta' consists of 4 fields:

| Field       | Description                   |
| ----------- | ----------------------------- |
| version     | Meta Algorithm Version        |
| seed        | Entity Name                   |
| key         | Public Key                    |
| fingerprint | Signature to generate address |

```
/* example: hulk */
{
    version     : 0x01,
    seed        : "hulk",
    key         : {
        algorithm : "RSA",
        data      : "-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDBUyaQPTvXgTfYC7bSAIhC3efc\nQT7HEX9PzJXQs9XeuxY4iBBBnrUPkJhOvwHrnAErBnM6tm9I45htcTeVOsi/qRbs\nXpQ6u7JuBayxgVp2vU0xUWDKLTlE9VT3F/OgT1xGuXnMO5TJnt/HjlbASToGUxBa\nrMWCrjQJX2UitMaU+wIDAQAB\n-----END PUBLIC KEY-----"
    },
    fingerprint : "SdxF0IU8Kq9sfD/x46uRC4W8VJ4WmVF8j0Je6ZMIURLoFju/SFEtSC41ibU7R6cgINfUpZ4QCfVpo0+rHwlXBNeyZS5vqf1+fvMuISucRWGjmFmusTAqtqN0RCDvhdkeaxuQyMJKAGlzkcm5CXeqWyijDOQOZyf2pGJlfs18e2c="
}
```

THe **fingerprint** field was generated by your **private key** and **seed**:

````
fingerprint = sign(seed, SK);
````

### 1.1. ID
The **ID** is used to identify an **entity**(account/group). It consists of 3 fields:

| Field       | Description                   |
| ----------- | ----------------------------- |
| name        | Same with meta.seed           |
| address     | Unique Identification         |
| terminal    | Login point, it's optional.   |

The ID format is ```name@address[/terminal]```.

```
/* examples */
ID1 = "hulk@4bejC3UratNYGoRagiw8Lj9xJrx8bq6nnN"; // immortal hulk
ID2 = "moki@4LrJHfGgDD6Ui3rWbPtftFabmN8damzRsi"; // monkey king
```

#### Name
The **Name** field is an entity name (username, or just a random string for group).

You can use any 'C' type variable naming string, e.g.: ```name = "moky";```

#### Address
The **Address** field was created by the 'Meta' info and the network ID:

````
// Network ID
enum {
    MKMNetwork_Main  = 0x08, // (Person)
    MKMNetwork_Group = 0x10, // (Multi-Persons)
};

// Address algorithm
function BUILD(fingerprint, network) {
    hash    = ripemd160(sha256(fingerprint));
    code    = sha256(sha256(network+hash)).prefix(4); // check code
    address = base58(network+hash+code);
}
````

### 1.2. Public Key
A **public key** (PK) was binding to an ID by the __Meta Algorithm__,
when you get a meta for the entity ID from the network,
you must verify it with the consensus algorithm before accept it:

```
network = MKMNetwork_Main;
CT      = meta.fingerprint;
PK      = meta.key;
name    = meta.seed;
address = BUILD(CT, network);

if (ID.name == name && ID.address == address && verify(name, CT, PK)) {
    correct = true;
} else {
    correct = false;
}
```

### 1.3. Entity (Account/Group)
**Entity** is the sender/receiver in the network communication.

An entity can be an account or a group. It has an **ID**, a **name**, and a **number** for searching.

An **account** will have a **public key**.

A **group** will have **founder**, **owner** and **members**.

```
user = new Account(ID, PK);
```

## 2. Message

### 2.0. Envelope

```
{
    sender   : "moki@4LrJHfGgDD6Ui3rWbPtftFabmN8damzRsi",
    receiver : "hulk@4bejC3UratNYGoRagiw8Lj9xJrx8bq6nnN",
    time     : 1541953306
}
```

### 2.1. Message Content

````
{
    type     : 0x01,       // message type
    sn       : 3125856764, // serial number (message ID in conversation)
    
    text     : "Hey guy!"
}
````

#### Message Type

````
enum {
    DIMMessageType_Unknown = 0x00,
    DIMMessageType_Text    = 0x01,
    
    DIMMessageType_File    = 0x10,
    DIMMessageType_Image   = 0x12,
    DIMMessageType_Audio   = 0x14,
    DIMMessageType_Video   = 0x16,
    
    DIMMessageType_Page    = 0x20,
    
    // quote a message before and reply it with text
    DIMMessageType_Quote   = 0x37,
    
    // system command
    DIMMessageType_Command = 0x88,
    
    // top-secret message forward by proxy
    DIMMessageType_Forward = 0xFF
};
````

### 2.2. Message

#### Instant Message

````
{
    //-------- head (envelope) --------
    sender   : "moki@4LrJHfGgDD6Ui3rWbPtftFabmN8damzRsi",
    receiver : "hulk@4bejC3UratNYGoRagiw8Lj9xJrx8bq6nnN",
    time     : 1541953306,
    
    //-------- body (content) ---------
    content  : {
        type : 0x01,       // message type
        sn   : 3125856764, // serial number (ID)
        text : "Hey guy!"
    }
    
}
````

content -> JsON string: ```{"sn":3125856764,"text":"Hey guy!","type":1}```

#### Secure Message

```
/**
 *  Algorithm:
 *      json = json(content);
 *      PW   = random();
 *      data = base64(encrpyt(json, PW));        // Symmetric
 *      key  = base64(encrypt(PW, receiver.PK)); // Asymmetric
 */
{
    //-------- head (envelope) --------
    sender   : "moki@4LrJHfGgDD6Ui3rWbPtftFabmN8damzRsi",
    receiver : "hulk@4bejC3UratNYGoRagiw8Lj9xJrx8bq6nnN",
    time     : 1541953306,
    
    //-------- body (content) ---------
    data     : "8QKyokYSV/YYCTTi7DhqtEMAyxL/OAKDZ4i72zSRaU8J3+uPLjfyJLj/hg016um/",
    key      : "SIkSKhy+Di8BbdLqASPoN7Wyzu1kzpwnIAhHxRy9fON/a2s/BnFRoh4g+5K4Q6TDmCNyjx6mkyaekzCfXU6WmilvVjpInYbORX4qTO6tM+XNXaaLEesBaVTg84FyFh6+onqX/I26kmlxmRAv7RibGdRsqMiKoFA0oFnm3CJTJWE="
}
```

#### Certified Message

```
/**
 *  Algorithm:
 *      ...
 *      signature = sign(data, sender.SK)
 */
{
    //-------- head (envelope) --------
    sender   : "moki@4LrJHfGgDD6Ui3rWbPtftFabmN8damzRsi",
    receiver : "hulk@4bejC3UratNYGoRagiw8Lj9xJrx8bq6nnN",
    time     : 1541953306,
    
    //-------- body (content) ---------
    data     : "8QKyokYSV/YYCTTi7DhqtEMAyxL/OAKDZ4i72zSRaU8J3+uPLjfyJLj/hg016um/",
    key      : "SIkSKhy+Di8BbdLqASPoN7Wyzu1kzpwnIAhHxRy9fON/a2s/BnFRoh4g+5K4Q6TDmCNyjx6mkyaekzCfXU6WmilvVjpInYbORX4qTO6tM+XNXaaLEesBaVTg84FyFh6+onqX/I26kmlxmRAv7RibGdRsqMiKoFA0oFnm3CJTJWE=",
    signature: "m8ZHX10apLYSprdGVWx5OVzT15fdMV9NSqODZx7OHUc1lgaH6yGIw7mD5H3oxNqqBdhQlVxdU/69yRxemdSttH42vjWt36WW1UGNae5Gi7fHy/pGBZgQbf1WnpPX6HXwN2g7v5kvFLnnncCtPMIUFRj2AJMj4kkn0waIldwKYOI="
}
```


---
Written by [Albert Moky](http://moky.github.com/) Sun Nov 11 23:18:08 CST 2018
